<!DOCTYPE html>
<html>
<head>
    <title>Upload Video File</title>
    <script src="/javascripts/jquery.min.js"></script>
	<link rel="stylesheet" href="/stylesheets/bootstrap.min.css">
    <link rel="stylesheet" href="/stylesheets/style.css">
    <script src="/javascripts/bootstrap.min.js"></script>
	<!-- Including jQuery Form plugin -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.form/3.51/jquery.form.min.js"></script>
</head>
<body>
	<div class="container">
		<h1>Upload</h1>
		<div class="well">
			<h2>Upload Video File</h2>
			<p class="text text-info">Upload video lên Wistia.</p>
			<p class="text text-muted">API URL: https://upload.wistia.com</p>
			<p class="text text-muted">api_password: <%=apiPassword%></p>
			
			<input type="text" id="projectId" class="form-control" value="fxipdx3zn1" placeholder="*Wistia Project ID"><br>
			<form id="FormFile" class="form form-horizontal" method="post">
				<input type="text" name="name" id="name" class="form-control" placeholder="New Video Name">
				<br>
				<input type="file" name="file" id="file" class="form-control" value="Choose a file" accept="video/*">
				<br>
				<img src="/icons/spin.gif" id="spinIcon" style="display:none">
				<input type="button" class="btn btn-success" value="Submit" id="FormFileUploadBtn">
			</form>
			<br>
			
			<div id="controlButton" style="display: none">
					<button type="button" class="btn btn-info" data-toggle="modal" data-target="#ViewVideoModal">Xem lại Video</button> &nbsp;
					<button type="button" class="btn btn-danger" id="deleteBtn">Xóa</button> &nbsp;
					<button type="button" class="btn btn-primary" id="sendBtn">Gửi Video sang Form kế tiếp</button> &nbsp;
			</div>
		</div>
		
		<div class="well" style="display:none"><pre id="message"></pre></div>
		
		<div class="modal fade" id="ViewVideoModal" tabindex="-1" role="dialog" aria-labelledby="ViewVideoModal">
			<div class="modal-dialog modal-lg" role="document">
				<div class="modal-content" id="modalContent"></div>
			</div>
		</div>
		
		
		
		<div class="well">
			<h2>Upload via URL</h2>
			<p class="text text-info">Gửi URL video đến Microsoft Video API và chuyển đến giao diện chờ nhận kết quả JSON</p>
			<p class="text text-muted">API URL: <%=apiURL%></p>
			<p class="text text-muted">Ocp-Apim-Subscription-Key: <%=subKey%></p>
			<form id="FormURL" class="form form-horizontal" method="post">
				<input type="url" id="url" class="form-control" name="url" id="url" value="http://techslides.com/demos/sample-videos/small.mp4" required>
				<br>
				<input type="submit" class="btn btn-success" value="Submit">
			</form>
		</div>
		
		<div class="well" id="info">
		</div>
	</div>
	
<script type="text/javascript">
	$(document).ready(function(){	
		
		$('#FormFileUploadBtn').on('click', function(e) {
            var form = new FormData();
			var file = $('#file')[0].files[0];
			form.append("file", file);
			form.append("name", $('#FormFile #name').val());
			$('#FormFileUploadBtn').attr('disabled','disabled');
			$('#spinIcon').css('display','inline');
			var params = {
				api_password : '<%=apiPassword%>', 
				project_id : $('#projectId').val(), 
			};
			$.ajax({
				async: true,
				crossDomain: true,
				url: "https://upload.wistia.com?" + $.param(params),
				method: "POST",
				processData: false,
				contentType: false,
				mimeType: "multipart/form-data",
				dataType: "json",
				data: form,
				success: function(data) {
					if (data.error) {
						alert("Lỗi: " + data.error);
					} else {
						$('#controlButton').css('display','block');
						$('#message').parent().css('display','block');
						$('#message').text(JSON.stringify(data, null, 2));						
						var hashedId = data.hashed_id;
						$('#hashedId').html(hashedId);
						var embededContent = '<script src="//fast.wistia.com/embed/medias/'+hashedId+'.jsonp" async><\/script><script src="//fast.wistia.com/assets/external/E-v1.js" async><\/script><div class="wistia_responsive_padding" style="padding:57.14% 0 0 0;position:relative;"><div class="wistia_responsive_wrapper" style="height:100%;left:0;position:absolute;top:0;width:100%;"><div class="wistia_embed wistia_async_'+hashedId+' videoFoam=true" style="height:100%;width:100%">&nbsp;</div></div></div>';
						$('#modalContent').append(embededContent);
					}
				},
				error: function(e) {
					alert("Gửi Ajax Request thất bại!");
				},
				complete: function() {
					$('#spinIcon').css('display','none');
				}
			});
			e.preventDefault();
        });	   
	   
		$( "#FormURL" ).submit(function( event ) {
			var params = {
				// Request parameters
			};
			$.ajax({
				url: "<%=apiURL%>?" + $.param(params),
				beforeSend: function(xhrObj){
					// Request headers
					xhrObj.setRequestHeader("Content-Type","application/json");
					xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key","<%=subKey%>");
				},
				type: 'POST',
				data: '{ "url" : "'+ $('#FormURL #url').val() +'"}',
				success: function(data, status, request) {
					$('#info').append('Đang gửi dữ liệu...').delay(5000);
					window.location.replace("/video-api/wait-for-result?operationLocation=" +request.getResponseHeader('Operation-Location'));
				},
				fail: function() {
					alert("Lỗi! Coi lại dữ liệu");
				}
			});
			event.preventDefault();
		});
		
		$('#deleteBtn').on('click', function(e) {
			if (!confirm(" Video vừa upload sẽ bị xóa khỏi Wistia. Chắc chắn xóa?")) {
				return false;
			}
			$('#spinIcon').css('display','inline');
			var params = {
				api_password : '<%=apiPassword%>', 
				project_id : $('#projectId').val(), 
			};
			$.ajax({
				url: "https://api.wistia.com/v1/medias/" + $('#hashedId').html() + ".json?" + $.param(params),
				method: "DELETE",
				success: function(data) {
					if (data.hashed_id) {
						$('#spinIcon').css('display','none');
						$('#FormFileUploadBtn').removeAttr('disabled');
						$('#message').text("Đã xóa!");
						$('#controlButton').css('display','none');
					}
				},
				complete: function(data) {
					$('#spinIcon').css('display','none');
				}
			});
			e.preventDefault();
        });	   
	});
</script>
<div style="display:none" id="hashedId"></div>
</body>
</html>